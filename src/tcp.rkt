#lang racket

;(require misc1/syntax)
(require libuuid)
(require "Struct.rkt")
(require readline)
(require readline/readline)
(install-readline!)
(require racket/future)
(require alexis/util/abbreviations)

(define CLIENTLIST (make-hash))

(define (loop id in)
    (define ClientInput (read-line in))
    (if (equal? ClientInput eof)
        (dln "EOF")
        (dln (string-append id "==>" ClientInput))
    )
    (if (equal? ClientInput eof)
        (lambda ()
            (dict-remove! CLIENTLIST id)
            (kill-thread (current-thread))
        )
        (loop id in)
    )
)

(define (handle in out)
    (define id (uuid-generate))
    (dln (string-append id " connected!"))
    (dict-set! CLIENTLIST id out)
    (display "HALLO\n" out)
    (flush-output out)
    (thread
        (loop id in)
    )
)

(define (accept-and-handle listener)
    (define-values (in out) (tcp-accept listener))
    (handle in out)
    (close-input-port in)
    (close-output-port out)
)

(define (serve port)
    (thread (lambda ()
        (startREPL)
    ))
    (define listener (tcp-listen port 5 #t))
    (define (loop)
        (accept-and-handle listener)
        (loop)
    )
    (define t (thread (loop)))
    (lambda ()
        (kill-thread t)
        (tcp-close listener)
    )
)

(define (brodcast message)
    (dict-for-each CLIENTLIST (lambda (k v)
        (printf "~a = ~s\n" k v)
        (cond
            ((port-closed? v)
                (dict-remove! CLIENTLIST k)
                (dln (string-append "Removed client" k "."))
            )
            (
                (dln (string-append "Send message to " k "."))
                (dln (string-append message "\n") v)
                (flush-output v)
            )
        )
    ))
)

(define (startREPL)
    (define (replLoop)
        (define input (readline "> "))
        (brodcast input)
        (replLoop)
    )
    (replLoop)
)

; Display with new line
(define (dln message)
    (display (string-append message "\n"))
)

(serve 8080)

(provide serve brodcast)