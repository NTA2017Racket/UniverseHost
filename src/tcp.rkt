#lang racket

;(require misc1/syntax)
(require libuuid)
(require "Struct.rkt")
(require readline)
(require readline/readline)
(install-readline!)
(require racket/future)
(require alexis/util/abbreviations)

(define CLIENTLIST (make-hash))

(define (loop id in)
    ;(display "Run loop2" (current-output-port))
    (define input (read-line in))
    (writeln (string-append "UUID: " id " | " input "\n"))
    ;(display (string-append "UUID: " id " | " input "\n") (current-output-port))
    (loop id in)
)

(define (handle in out)
    (define id (uuid-generate))
    (display (string-append id " connected!\n") (current-output-port))
    (dict-set! CLIENTLIST id out)
    (display "HALLO\n" out)
    (flush-output out)
    (thread
        (loop id in)
    )
)

(define (accept-and-handle listener)
    (define-values (in out) (tcp-accept listener))
    (thread
        (lambda ()
            (handle in out)
            (close-input-port in)
            (close-output-port out)
        )
    )
)

(define (serve port)
    (thread (lambda ()
        (startREPL)
    ))
    (define listener (tcp-listen port 5 #t))
    (define (loop)
        (accept-and-handle listener)
        (loop)
    )
    (define t (thread (loop)))
    (lambda ()
        (kill-thread t)
        (tcp-close listener)
    )
)

(define (brodcast message)
    ;(display "Test" (current-output-port))
    (dict-for-each CLIENTLIST (lambda (k v)
        (printf "~a = ~s\n" k v)
        (writeln (port-closed? v))
        (cond
            ((port-closed? v)
                (dict-remove! CLIENTLIST k)
                (writeln (string-append "Removed client" k "."))
            )
            (
                (writeln (tcp-addresses v))
                (writeln (string-append "Send message to " k "."))
                (display (string-append message "\n") v)
                (flush-output v)
            )
        )
    ))
)

(define (startREPL)
    (define (replLoop)
        (define input (readline "> "))
        (brodcast input)
        (replLoop)
    )
    (replLoop)
)

(serve 8080)

(provide serve brodcast)